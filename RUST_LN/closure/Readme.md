# ä¸€ã€å…ˆæŠŠâ€œlambda / é—­åŒ…â€ä»è„‘å­é‡Œå»ç¥ç§˜åŒ–

## ä¸€å¥è¯ç›´è§‰ï¼ˆå…ˆè®°ï¼‰

> **Rust çš„é—­åŒ… = â€œèƒ½è®°ä½å‘¨å›´å˜é‡çš„åŒ¿åå‡½æ•°â€**

å’Œæ•°å­¦ã€å‡½æ•°å¼ç¼–ç¨‹ã€Monad **æ²¡å…³ç³»**
ä½ æŠŠå®ƒå½“æˆï¼š

> **â€œå†™åœ¨å‡½æ•°æ—è¾¹çš„ä¸€æ¬¡æ€§å°å‡½æ•°â€**

---

# äºŒã€æœ€æœ€åŸºç¡€çš„ lambdaï¼ˆä¸å¸¦ä»»ä½•èŠ±æ´»ï¼‰

## æ™®é€šå‡½æ•°

```rust
fn add(a: i32, b: i32) -> i32 {
    a + b
}
```

## Rust é—­åŒ…ç‰ˆæœ¬

```rust
let add = |a: i32, b: i32| -> i32 {
    a + b
};
```

ä½ åªéœ€è¦è®¤è¯†ä¸‰å—ï¼š

```
|å‚æ•°| -> è¿”å›å€¼ { å‡½æ•°ä½“ }
```

âš ï¸ å¾ˆå¤šæ—¶å€™ **è¿”å›å€¼å¯ä»¥ä¸å†™**ï¼š

```rust
let add = |a: i32, b: i32| a + b;
```

---

# ä¸‰ã€ä¸ºä»€ä¹ˆè¦æœ‰é—­åŒ…ï¼Ÿï¼ˆä¸æ˜¯ä¸ºäº†è£…é€¼ï¼‰

å› ä¸ºä½ ç»å¸¸ä¼šå†™è¿™ç§ä»£ç ï¼š

```rust
for x in vec {
    if x > 3 {
        println!("{}", x);
    }
}
```

è€Œ Rust æƒ³è®©ä½ å†™æˆï¼š

```rust
vec.iter().filter(|x| **x > 3);
```

è¿™é‡Œçš„ `|x| *x > 3` å°±æ˜¯ä¸€ä¸ª**ä¸´æ—¶åˆ¤æ–­å‡½æ•°**ã€‚

---

# å››ã€é—­åŒ…æœ€é‡è¦çš„ç‰¹æ€§ï¼šå®ƒä¼šâ€œå·â€å¤–é¢çš„å˜é‡

çœ‹è¿™ä¸ªï¼š

```rust
let threshold = 3;

let is_big = |x: &i32| *x > threshold;
```

è¿™é‡Œå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ

* `threshold` **ä¸æ˜¯å‚æ•°**
* ä½†é—­åŒ…**å¯ä»¥ç”¨**
* Rust ä¼šè‡ªåŠ¨â€œæŠ“ä½â€å®ƒ

ğŸ‘‰ è¿™å°±æ˜¯â€œé—­åŒ…ï¼ˆclosureï¼‰â€è¿™ä¸ªåå­—çš„ç”±æ¥
å®ƒ**æŠŠå‘¨å›´ç¯å¢ƒâ€œåŒ…â€è¿›æ¥äº†**

---

# äº”ã€é—­åŒ… â‰  å‡½æ•°ï¼ˆè¿™æ˜¯ä½ ç°åœ¨æœ€å®¹æ˜“ç‚¸çš„ç‚¹ï¼‰

### æ™®é€šå‡½æ•°åšä¸åˆ°è¿™ä¸ª

```rust
fn is_big(x: &i32) -> bool {
    *x > threshold   // âŒ threshold ä¸å­˜åœ¨
}
```

### ä½†é—­åŒ…å¯ä»¥

```rust
let threshold = 3;
let is_big = |x: &i32| *x > threshold;
```

---

# å…­ã€é—­åŒ…çš„ 3 ç§â€œæ‹¿å˜é‡æ–¹å¼â€ï¼ˆè¿™æ˜¯æœ€æ ¸å¿ƒçš„ï¼‰

Rust é—­åŒ…ä¼š**è‡ªåŠ¨åˆ¤æ–­**ç”¨å“ªä¸€ç§ï¼š

| æ–¹å¼       | äººè¯  | ä»€ä¹ˆæ—¶å€™       |
| -------- | --- | ---------- |
| `&T`     | åªçœ‹  | å¤§å¤šæ•°æƒ…å†µ      |
| `&mut T` | æˆ‘è¦æ”¹ | ä½ åœ¨é—­åŒ…é‡Œä¿®æ”¹    |
| `T`      | æˆ‘æ‹¿èµ° | ä½ åœ¨é—­åŒ…é‡Œ move |

### ä¾‹å­ 1ï¼šåªçœ‹ï¼ˆæœ€å¸¸è§ï¼‰

```rust
let threshold = 3;
let f = |x: i32| x > threshold;
```

ç­‰ä»·äºï¼š

```rust
let f = |x: i32| x > &threshold;
```

---

### ä¾‹å­ 2ï¼šä¿®æ”¹å¤–éƒ¨å˜é‡

```rust
let mut sum = 0;

let mut add = |x: i32| {
    sum += x;
};

add(3);
add(5);

println!("{}", sum); // 8
```

è¿™é‡Œé—­åŒ…**å·å·æ‹¿äº† `&mut sum`**

---

### ä¾‹å­ 3ï¼šç›´æ¥æ‹¿èµ°ï¼ˆmoveï¼‰

```rust
let s = String::from("hello");

let f = move || {
    println!("{}", s);
};
```

è¿™é‡Œï¼š

* `s` è¢« **move è¿›é—­åŒ…**
* å¤–é¢ä¸èƒ½å†ç”¨ `s`

`move` æ˜¯ä½ **å¼ºåˆ¶è¦æ±‚â€œæ‹¿èµ°â€**

---

# ä¸ƒã€ç°åœ¨å›å¤´çœ‹é‚£æ®µä½ â€œçœ‹ä¸æ‡‚â€çš„ä»£ç 

```rust
s.parse::<i32>()
    .map_err(|_| format!("cannot parse '{}'", s))?;
```

æˆ‘ä»¬ä¸€åˆ€ä¸€åˆ€æ‹†ã€‚

---

## 1ï¸âƒ£ `map_err` æ˜¯ä»€ä¹ˆï¼Ÿ

äººè¯ç‰ˆï¼š

> â€œå¦‚æœæ˜¯ Errï¼Œæˆ‘å¸®ä½ æ”¹ä¸€ä¸‹é”™è¯¯å†…å®¹â€

ç­¾åï¼ˆä¸ç”¨è®°ï¼‰ï¼š

```rust
fn map_err<F>(self, f: F) -> Result<T, E2>
where
    F: FnOnce(E) -> E2
```

ä½ åªéœ€è¦çŸ¥é“ï¼š

* `f` æ˜¯ä¸€ä¸ª **å‡½æ•° / é—­åŒ…**
* è¾“å…¥ï¼šåŸé”™è¯¯
* è¾“å‡ºï¼šæ–°é”™è¯¯

---

## 2ï¸âƒ£ è¿™ä¸ªé—­åŒ…åˆ°åº•åœ¨å¹²å˜›ï¼Ÿ

```rust
|_| format!("cannot parse '{}'", s)
```

è¯»æ³•ï¼š

* `|_|`ï¼š
  â€œæˆ‘ä¸å…³å¿ƒåŸæ¥çš„é”™è¯¯æ˜¯ä»€ä¹ˆâ€
* `format!(...)`ï¼š
  ç”Ÿæˆæ–°çš„é”™è¯¯å­—ç¬¦ä¸²
* `s`ï¼š
  ä»å¤–é¢â€œæŠ“â€è¿›æ¥çš„å˜é‡

ç¿»è¯‘æˆæ™®é€šå‡½æ•°æ€ç»´ï¼š

```rust
fn convert_error(_: åŸé”™è¯¯ç±»å‹) -> String {
    format!("cannot parse '{}'", s)
}
```

åªæ˜¯ä½ ä¸ç”¨å•ç‹¬å†™å‡½æ•°äº†ã€‚

---

## 3ï¸âƒ£ `?` åœ¨è¿™é‡Œå¹²å˜›ï¼Ÿ

```rust
.map_err(...)?
```

æ„æ€æ˜¯ï¼š

> å¦‚æœç°åœ¨æ˜¯ `Err`
> ğŸ‘‰ ç›´æ¥ return Err(...)
> å¦‚æœæ˜¯ `Ok`
> ğŸ‘‰ è§£åŒ…ç»§ç»­

---

# å…«ã€ç»™ä½ ä¸€ä¸ªâ€œé—­åŒ…é˜…è¯»å£è¯€â€ï¼ˆæ•‘å‘½ç”¨ï¼‰

ä»¥åä½ çœ‹åˆ°ï¼š

```rust
|x| expr
```

ä½ å°±å¼ºåˆ¶è‡ªå·±ç¿»è¯‘æˆï¼š

> â€œæœ‰ä¸€ä¸ªä¸´æ—¶å‡½æ•°ï¼Œ
> å‚æ•°æ˜¯ xï¼Œ
> è¿”å› exprï¼Œ
> é¡ºä¾¿å¯èƒ½ç”¨äº†å¤–é¢çš„å˜é‡â€

åªè¦ä½ èƒ½ç¿»è¯‘æˆè¿™å¥è¯ï¼Œä½ å°±**æ²¡çœ‹ä¸æ‡‚**ã€‚

---

# ä¹ã€ç°åœ¨ç»™ä½ **è¶…æ…¢é€Ÿç»ƒä¹ ï¼ˆçœŸÂ·æ•™å­¦ç”¨ï¼‰**

## ç»ƒä¹  Aï¼šä¸ç”¨ iteratorï¼Œåªç†è§£é—­åŒ…

```rust
let add = |a: i32, b: i32| a + b;
println!("{}", add(3, 4));
```

---

## ç»ƒä¹  Bï¼šé—­åŒ…æŠ“å˜é‡

```rust
let k = 10;
let bigger = |x: i32| x > k;
println!("{}", bigger(15));
```

---

## ç»ƒä¹  Cï¼šé—­åŒ…æ”¹å¤–éƒ¨å˜é‡

```rust
let mut sum = 0;
let mut add = |x: i32| sum += x;

add(3);
add(7);

println!("{}", sum);
```

---

## ç»ƒä¹  Dï¼ˆå…³é”®ï¼‰ï¼šç»™æˆ‘è§£é‡Šè¿™è¡Œä»£ç ï¼ˆäººè¯ï¼‰

```rust
.map_err(|e| format!("parse failed: {}", e))
```

ä¸ç”¨å†™ä»£ç ï¼Œç”¨ä¸€å¥è¯è§£é‡Šã€‚
